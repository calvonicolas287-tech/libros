<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Detalle del Libro</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto py-8">
    <div id="detalle" class="bg-white p-6 rounded shadow"></div>
    <div class="mt-6 space-x-4">
      <button onclick="addToCart()" class="bg-blue-600 text-white px-4 py-2 rounded">Agregar al carrito</button>
      <button onclick="comprarAhora()" class="bg-green-600 text-white px-4 py-2 rounded">Comprar ahora</button>
      <a href="index.html" class="text-gray-600 hover:underline">← Volver</a>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const libro = JSON.parse(localStorage.getItem('libroDetalle'));
    const token = localStorage.getItem('token') || '';
    const cont = document.getElementById('detalle');

    if (libro) {
      cont.innerHTML = `
        <img src="${libro.image}" alt="${libro.title}" class="w-full h-64 object-cover rounded mb-4"/>
        <h2 class="text-2xl font-bold mb-2">${libro.title}</h2>
        <p class="mb-2 text-gray-700">${libro.description}</p>
        <p class="mb-4 font-semibold">Precio: $${libro.price.toFixed(2)}</p>
      `;
    }

    function addToCart() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const existente = cart.find(item => item.id === libro.id);

      if (existente) {
        existente.quantity += 1;
      } else {
        cart.push({ id: libro.id, title: libro.title, price: libro.price, quantity: 1 });
      }

      localStorage.setItem('cart', JSON.stringify(cart));
      alert('Libro agregado al carrito');
    }

    function comprarAhora() {
      if (!token) {
        alert('Debes iniciar sesión antes de comprar');
        return window.location.href = 'login.html';
      }

      fetch(`${API_URL}/crear-preferencia`, {
        method: 'POST',
        headers: {
          'Content-Type':  'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          cart: [{ id: libro.id, title: libro.title, price: libro.price, quantity: 1 }]
        })
      })
      .then(r => r.json())
      .then(d => window.location.href = d.init_point)
      .catch(() => alert('Error al procesar el pago'));
    }
  </script>
</body>
</html>